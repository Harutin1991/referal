function setParam () {
    "use strict";
    var params = {
        winHeight: $(window).height(),
        winWidth: $(window).width(),
        bodyHeight: $('body').height(),
        bodyWidth: $('body').width(),
        page: $('input[name="page"]').attr('value'),
        page_param: $('input[name="page_param"]').attr('value'),
        page_type: $('input[name="page_type"]').attr('value'),
        page_id: $('input[name="page_id"]').attr('value')
    };
    return params;
}
function hideConfrim() {
    "use strict";
    $('.confrim').fadeOut(100);
}
function setTinymce() {
    "use strict";
    tinymce.init({
        selector: 'textarea.tinymce',
        language: 'ru',
        height: 250,
        theme: 'modern',
        fontsize_formats: '8px 10px 12px 14px 16px 18px 20px 22px 24px 36px',
        plugins: [
            'advlist autolink lists link image charmap print preview hr anchor pagebreak',
            'searchreplace wordcount visualblocks visualchars code fullscreen',
            'insertdatetime media nonbreaking save table contextmenu directionality',
            'emoticons template paste textcolor colorpicker textpattern imagetools moxiemanager'
        ],
        toolbar1: 'undo redo | styleselect fontsizeselect | forecolor backcolor | bold italic underline | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image media insertfile',
        toolbar2: "pagebreak paste  hr spellchecker  visualblocks visualchars inserttime insertdate charmap searchreplace removeformat inserttable outdent indent emoticons print preview fullscreen",
        image_advtab: true,
        relative_urls : false
    });
}
function imageDropzoneUpload() {
    "use strict";
    var vid,pid,data,myDropzoneGlobal,i=0,success=false;
    vid = $('#myDropzone').find('input[name="vid"]').val();
    pid = $('#myDropzone').find('input[name="pid"]').val();
    if(pid==='' || pid==='NULL') {
        pid = 'NULL'
    }
    myDropzoneGlobal = Dropzone.options.myDropzone = {
        method: 'post',
        url: '/admin-panel/dist/js/ajax/image.mydropzone.upload.php',
        parallelUploads: true,
        maxFilesize: 2,
        filesizeBase: 1024,
        paramName: 'file',               
        uploadMultiple: false,
        addRemoveLinks : false,
        previewsContainer: '#myDropzoneImagesSortable',
        clickable: false,
        maxThumbnailFilesize: 2,
        thumbnailWidth: 400,
        thumbnailHeight: 300,
        maxFiles: 15,
        acceptedFiles: 'image/*',
        autoProcessQueue: true,
        previewTemplate: document.querySelector('#myDropzoneImagesContainer').innerHTML,
        forceFallback: false,
        dictDefaultMessage: $('.dictDefaultMessage').html(),
        dictFallbackMessage: '',
        dictFallbackText: '',
        dictInvalidFileType: '',
        dictFileTooBig: '',
        dictCancelUpload: $('.dictCancelUpload').html(),
        dictCancelUploadConfirmation: '',
        dictRemoveFile: $('.dictRemoveFile').html(),
        dictMaxFilesExceeded: '',                               
        init: function() {
            this.on("sending", function(file, xhr, formData){
                formData.append('vid', vid);
            }),
            this.on("sending", function(file, xhr, formData){
                formData.append('pid', pid);
            }),
            this.on("drop", function(){
                $('#myDropzone').find('div#myDropzoneImagesLoading').removeClass('none');
                $('#myDropzone').find('div#myDropzoneImagesSortable').addClass('none');
            }),
            this.on("removedfile", function(file) {   
                var remove = $(file.previewElement).find('a.dz-remove').attr('data-dz-remove');
                var imagename = $(file.previewElement).find('a.dz-remove').attr('data-dz-name');
                imageDelete(remove,vid,false,imagename);
            });
        },
        success: function(file,response) {
            response = $.parseJSON('['+response+']');
            if(response[0].response_status==='200') { 
                success = true;
                data = $('#myDropzone').find('input[name="data"]').val();
                $(file.previewElement).find('a.dz-remove').attr('data-dz-remove',data);
                $(file.previewElement).find('a.dz-remove').attr('data-dz-name',response[0].response_file_name);
                data = (data*1)+1;
                $('#myDropzone').find('input[name="data"]').val(data);
            } else  if(response[0].response_status==='100') {
                $('#myDropzoneImagesSortable').find('.col-xs-12').each(function() {
                    $(this).remove();
                });
                $('#myDropzone').find('div#myDropzoneImagesLoading').addClass('none');
                $('#myDropzone').find('div#myDropzoneImagesSortable').removeClass('none');
                $('#myDropzone').find('div#myDropzoneImagesError').removeClass('none');
            } else  if(response[0].response_status==='101') {
                $('#myDropzoneImagesSortable').find('.col-xs-12').each(function() {
                    $(this).remove();
                });
                $('#myDropzone').find('div#myDropzoneImagesLoading').addClass('none');
                $('#myDropzone').find('div#myDropzoneImagesSortable').removeClass('none');
                $('#myDropzone').find('div#myDropzoneImagesErrorType').removeClass('none');
            }
        },
        totaluploadprogress: function(uploadProgress,totalBytes,totalBytesSent) {
            if(uploadProgress===100 && vid!=='NULL' && vid!=='') { 
                $('#myDropzone').find('div#myDropzoneImagesLoading').addClass('none');
                $('#myDropzone').find('div#myDropzoneImagesSortable').removeClass('none');
                setTimeout(function() {
                    setSortableHeight();
                }, 1000);
            }
        }                
    }
}
function imageUpload(e) {
    "use strict";
    var form,count,parent,params,vid,pid;
    form = new FormData(document.getElementById("myDropzone"));
    parent = $('#myDropzone');
    params = Array();
    params[0] = $('#myDropzone').find('input[name="vid"]').val();
    params[1] = $('#myDropzone').find('input[name="pid"]').val();
    if(pid==='') {
        pid = 'NULL'
    }
    if(params.length!==0) {
        params = params.join();
        form.append("params",params);
    }
    $.ajax({
        type: "POST",
        enctype: 'multipart/form-data',
        async: true,
        processData: false,
        contentType: false,
        data: form,
        dataType: "json",
        url: "/admin-panel/dist/js/ajax/image.upload.php",
        beforeSend: function() {
            $('#myDropzone').find('div#myDropzoneImagesLoading').removeClass('none');
            $('#myDropzone').find('div#myDropzoneImagesSortable').addClass('none');
        },
        success: function(response) {
            var complete = false,path;
            if(response.response_status==='200') {
                var data = $('#myDropzone').find('input[name="data"]').val();
                var vid = $('#myDropzone').find('input[name="vid"]').val();
                if(vid==='-1') {
                    path = 'tinymce';
                } else {
                    path = 'photo';
                }
                for (var i = 0; i < response.response.length; i++) {
                    if(response.response[i].error==='') {
                        $('#myDropzoneImagesSortable').append('<div class="col-lg-3 col-md-3 col-sm-4 col-xs-12 dz-image dz-processing dz-image-preview dz-complete"><div class="img-responsive-container"><img src="/images/'+path+'/small/'+response.response[i].name+'" class="img-responsive" data-dz-thumbnail width="400" height="300"></div><a href="javascript:void(0);" class="dz-remove none btn-custom" data-dz-remove="'+data+'" data-dz-name="'+response.response[i].name+'" onclick="imageDelete(null,'+vid+',true,$(this));">'+$('.dictRemoveFile').html()+'</a><a href="javascript:void(0);" class="none btn-custom" onclick="imageSortable($(this),true);">'+$('.dictMakeMain').html()+'</a></div>');
                        data = (data*1)+1;
                        $('#myDropzone').find('input[name="data"]').val(data);
                    } else {
                        //error show
                    }
                    if((i+1)===response.response.length) {
                        complete = true;
                    }
                }
            } else if(response.response_status==='100') {
                $('#myDropzoneImagesSortable').find('.col-xs-12').each(function() {
                    $(this).remove();
                });
                $('#myDropzone').find('div#myDropzoneImagesLoading').addClass('none');
                $('#myDropzone').find('div#myDropzoneImagesSortable').removeClass('none');
                $('#myDropzone').find('div#myDropzoneImagesError').removeClass('none');
            } else if(response.response_status==='101') {
                $('#myDropzoneImagesSortable').find('.col-xs-12').each(function() {
                    $(this).remove();
                });
                $('#myDropzone').find('div#myDropzoneImagesLoading').addClass('none');
                $('#myDropzone').find('div#myDropzoneImagesSortable').removeClass('none');
                $('#myDropzone').find('div#myDropzoneImagesErrorType').removeClass('none');
            } else {
                complete = true;
            }
            if(complete===true) {
                $('#myDropzone').find('div#myDropzoneImagesLoading').addClass('none');
                $('#myDropzone').find('div#myDropzoneImagesSortable').removeClass('none');
                setTimeout(function() {
                    setSortableHeight();
                }, 1000);
            }
        }
    });  
}
function imageSortable(e,type) {
    var name = '',image,position,params = Array(),i = 0,
        vid = $('#myDropzone').find('input[name="vid"]').val();
    if(type===true) {
        e.parents('div.dz-image').insertBefore('#myDropzoneImagesSortable div.dz-image:first-child');
    }
    $('#myDropzoneImagesSortable').find('.col-xs-12 a.dz-remove').each(function() {
        $(this).attr('data-dz-remove',i);
        i += 1;
    });
    $('#myDropzoneImagesSortable').find('.col-xs-12 a.dz-remove').each(function() {
        image = $(this).attr('data-dz-name');
        position = $(this).attr('data-dz-remove');
        params[position] = image;
    });
    $.ajax({
        type: "POST",
        dataType: "json",
        data: { vid:vid, name:name, params:params },
        url: "/admin-panel/dist/js/ajax/image.sortable.php",
        async: true,
        success: function(response) {
            if(response.response_status==='200') { }
        }
    });
}
function imageDelete(e,i,type,t) {
    "use strict";
    var complete = false,u;
    if(type===true) {
        e = t.attr('data-dz-remove');
        u = t.attr('data-dz-name');
    } else {
        u = t;
    }
    if(e==='0') {
        e = 'last';
    }
    $.ajax({
        type: "POST",
        dataType: "json",
        data: { vid:i, number:e , image:u },
        url: "/admin-panel/dist/js/ajax/image.delete.php",
        async: true,
        success: function(response) {
            if(response.response_status==='200') {
                if(type===true) {
                    t.parents('div.dz-image').fadeOut(0,function() {
                        this.remove();
                        complete = true;
                    });
                }
                var n = 0;
                $('#myDropzoneImagesSortable').find('a.dz-remove').each(function() {
                    $(this).attr('data-dz-remove',n);
                    n += 1;
                });
                $('#myDropzone').find('input[name="data"]').val(n);
                if(complete===true) {
                    setSortableHeight();
                }
            };
        }
    });
}
function setSortableHeight() {
    "use strict";
    var data = $('#myDropzone').find('input[name="data"]').val(),
        row,
        sortableHeight,
        winWidth = $(window).width();
    if(winWidth>=975) {
        row = Math.ceil((data)/4);
    } else if(winWidth<975 && winWidth>=751) {
        row = Math.ceil((data)/3);
    } else { 
        row = data;
    }
    sortableHeight = $("#myDropzoneImagesSortable div.dz-image:first-child").height();
    $('#myDropzoneImagesSortable').css('min-height',sortableHeight*row);
}
function setGroup(e) {
    "use strict";
    var val = e.val();
    if(val!='NULL') {
        window.location.pathname = '/admin-panel/photo/'+val+'/'; 
    } else {
        window.location.pathname = '/admin-panel/photo/'; 
    }
}
function setGroupType(e) {
    "use strict";
    var val = e.val(),
        page_param = $('input[name="page_param"]').attr('value');
    if(val!='NULL') {
        window.location.pathname = '/admin-panel/photo/'+page_param+'/'+val+'/'; 
    } else if(page_param!='NULL') {
        window.location.pathname = '/admin-panel/photo/'+page_param+'/'; 
    } else {
        window.location.pathname = '/admin-panel/photo/'; 
    }
}
function itemSortable(page) {
    "use strict";
    var key,send='';
    $('div#item-sortable').find('div.col-item').each(function() {
        key = $(this).attr('data-key');
        send += key+',';
    });
    $.ajax({
        type: "POST",
        dataType: "json",
        data: { send:send, page:page },
        url: "/admin-panel/dist/js/ajax/item.sortable.php",
        async: true
    });
}
function itemDelete(e) {
    "use strict";
    var params = setParam(),
        key = parseInt(e.parents('div.col-item').attr('data-key')),
        image = e.parents('div.col-item').attr('data-image');
    return confirm('Подтвердите удаление'),
    $.ajax({
        type: "POST",
        dataType: "json",
        data: { key:key, image:image, page:params['page'] },
        url: "/admin-panel/dist/js/ajax/item.delete.php",
        async: true,
        success: function(response) {
            if(response.response_status===200) {
                window.location.href = '';
            };
        }
    });
}
function pageDelete(e) {
    "use strict";
    var key = parseInt(e.attr('data-key')),
        image = e.attr('data-image');
    return confirm('Подтвердите удаление'),
    $.ajax({
        type: "POST",
        dataType: "json",
        data: { key:key, image:image },
        url: "/admin-panel/dist/js/ajax/page.delete.php",
        async: true,
        success: function(response) {
            if(response.response_status===200) {
                window.location.pathname = '/admin-panel/add-page/';
            };
        }
    });
}
$(document).ready(function() {
    "use strict";
    setTinymce();
    var params = setParam();
    if(params['page']==='photo'){
        imageDropzoneUpload();
        $("#myDropzoneImagesSortable").sortable({
            containment:"parent",
            tolerance: "pointer",
            update:function( event, ui ) {
                imageSortable(null,false);
            }
        });
        $('#myDropzoneImagesSortable').disableSelection();
    }
    if(params['page']!=='blog' && params['page']!=='photo' && params['page']!=='price') {
        $("#item-sortable").sortable({
            containment: "parent",
            tolerance: "pointer",
            update:function( event, ui ) {
                itemSortable(params['page']);
            }
        });
        $('#item-sortable').disableSelection();
    }
});
$(window).resize(function() {
    "use strict";
    var params = setParam();
    if(params['page']==='photo') {
        setSortableHeight();
    }
});
$(window).load(function() {
    "use strict";
    var params = setParam();
    if(params['page']==='photo') {
        setSortableHeight();
    }
});